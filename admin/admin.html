<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - WHIP-HELMETS</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <header>
        <script>
    // Verificar autenticaci√≥n antes de cargar el panel
    const authToken = localStorage.getItem('authToken');
    const userInfo = localStorage.getItem('userInfo');
    
    // Para desarrollo, permitir acceso sin autenticaci√≥n estricta
    const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    if (!isDevelopment && (!authToken || !userInfo)) {
        // No hay token o informaci√≥n de usuario, redirigir al login principal
        window.location.href = '/';
        alert('Debes iniciar sesi√≥n primero');
    } else if (!isDevelopment) {
        try {
            const user = JSON.parse(userInfo);
            if (user.role !== 'admin') {
                // Usuario no es admin, redirigir
                window.location.href = '/';
                alert('Acceso denegado. Se requiere rol de administrador');
            }
        } catch (error) {
            // Error al parsear la informaci√≥n del usuario
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/';
            alert('Error en la sesi√≥n. Por favor inicia sesi√≥n nuevamente');
        }
    }
</script>
        <div class="logo">
            <h1>WHIP-HELMETS - Panel de Administraci√≥n</h1>
        </div>
        <div class="admin-actions">
            <button class="btn btn-success" id="add-product">Agregar Producto</button>
            <button class="btn btn-primary" id="save-all">Guardar Todos los Cambios</button>
            <button class="btn btn-secondary" id="export-data">Exportar Datos</button>
            <button class="btn btn-success" id="manage-users">Gestionar Usuarios</button>
            <a href="/" class="btn btn-primary">Volver a la Tienda</a>
            <button class="btn btn-danger" id="logout">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="admin-container">
        <!-- Panel de Productos -->
        <div id="products-panel" class="admin-panel">
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="search">Buscar Producto</label>
                        <input type="text" id="search" placeholder="Nombre, marca, modelo...">
                    </div>
                    <div class="filter-group">
                        <label for="category">Categor√≠a</label>
                        <select id="category">
                            <option value="all">Todas las categor√≠as</option>
                            <option value="cascos">Cascos</option>
                            <option value="accesorios">Accesorios</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="brand">Marca</label>
                        <select id="brand">
                            <option value="all">Todas las marcas</option>
                            <option value="fox">Fox</option>
                            <option value="bell">Bell</option>
                            <option value="fly">Fly Racing</option>
                            <option value="alpinestars">Alpinestars</option>
                            <option value="aircraft">Aircraft</option>
                            <option value="troylee">Troy Lee Design</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status-filter">Estado</label>
                        <select id="status-filter">
                            <option value="all">Todos los estados</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="condition-filter">Condici√≥n</label>
                        <select id="condition-filter">
                            <option value="all">Todas las condiciones</option>
                            <option value="Nuevo">Nuevo</option>
                            <option value="Usado">Usado</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="stock-filter">Filtrar por Stock</label>
                        <select id="stock-filter">
                            <option value="all">Todos</option>
                            <option value="low">Stock Bajo (‚â§ 5)</option>
                            <option value="medium">Stock Medio (6-15)</option>
                            <option value="high">Stock Alto (> 15)</option>
                            <option value="out">Sin Stock</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="price-range">Rango de Precios</label>
                        <input type="range" id="price-range" min="0" max="1000000" step="50000">
                        <output id="price-output">Todos los precios</output>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" id="apply-filters">Aplicar Filtros</button>
                        <button class="btn" id="reset-filters">Restablecer</button>
                    </div>
                </div>
            </div>

            <table class="products-table">
                <thead>
                    <tr>
                        <th>Imagen</th>
                        <th>Nombre del Producto</th>
                        <th>Marca</th>
                        <th>Precio Normal</th>
                        <th>% Descuento</th>
                        <th>Categor√≠a</th>
                        <th>Condici√≥n</th>
                        <th>Talles Disponibles</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="products-body">
                    <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>

            <div class="pagination" id="pagination">
                <!-- La paginaci√≥n se generar√° aqu√≠ -->
            </div>
        </div>

        <!-- Panel de Usuarios -->
        <div id="users-panel" class="admin-panel" style="display: none;">
            <div class="users-header">
                <h2>Gesti√≥n de Usuarios</h2>
                <div class="users-actions">
                    <button class="btn btn-primary" id="back-to-products">Volver a Productos</button>
                    <button class="btn btn-success" id="add-user">Agregar Usuario</button>
                </div>
            </div>
            
            <div class="users-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="user-search">Buscar Usuario</label>
                        <input type="text" id="user-search" placeholder="Username, nombre, email...">
                    </div>
                    <div class="filter-group">
                        <label for="role-filter">Filtrar por Rol</label>
                        <select id="role-filter">
                            <option value="all">Todos los roles</option>
                            <option value="admin">Administradores</option>
                            <option value="user">Usuarios</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" id="apply-user-filters">Aplicar Filtros</button>
                        <button class="btn" id="reset-user-filters">Restablecer</button>
                    </div>
                </div>
            </div>

            <table class="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Fecha de Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-body">
                    <!-- Los usuarios se cargar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>

            <div class="pagination" id="users-pagination">
                <!-- La paginaci√≥n se generar√° aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- Modal para agregar nuevo producto -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Agregar Nuevo Producto</h2>
            <form id="new-product-form">
                <div class="form-group">
                    <label for="new-name">Nombre del Producto</label>
                    <input type="text" id="new-name" required>
                </div>
                <div class="form-group">
                    <label for="new-brand">Marca</label>
                    <div class="brand-input-container">
                        <select id="new-brand" required>
                            <option value="">Seleccione una marca</option>
                            <option value="fox">Fox</option>
                            <option value="bell">Bell</option>
                            <option value="fly">Fly Racing</option>
                            <option value="alpinestars">Alpinestars</option>
                            <option value="aircraft">Aircraft</option>
                            <option value="troylee">Troy Lee Design</option>
                            <option value="new">+ Agregar nueva marca</option>
                        </select>
                        <input type="text" id="new-brand-input" placeholder="Escriba la nueva marca" style="display: none;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="new-price">Precio Normal</label>
                    <input type="number" id="new-price" min="0" required>
                </div>
                <div class="form-group">
                    <label for="new-porcentaje-descuento">% Descuento Efectivo/Transferencia</label>
                    <input type="number" id="new-porcentaje-descuento" min="0" max="100" step="0.1" placeholder="Ej: 10.5">
                    <small class="form-help">Porcentaje de descuento (0-100). Dejar vac√≠o si no aplica descuento</small>
                </div>
                <div class="form-group">
                    <label for="new-category">Categor√≠a</label>
                    <select id="new-category" required>
                        <option value="">Seleccione una categor√≠a</option>
                        <option value="Cascos">Cascos</option>
                        <option value="Accesorios">Accesorios</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-condition">Condici√≥n</label>
                    <select id="new-condition" required>
                        <option value="">Seleccione la condici√≥n</option>
                        <option value="Nuevo">Nuevo</option>
                        <option value="Usado">Usado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-sizes">Talles Disponibles (separados por comas)</label>
                    <input type="text" id="new-sizes" placeholder="S, M, L, XL">
                </div>
                <div class="form-group">
                    <label for="new-stock">Cantidad en Stock</label>
                    <input type="number" id="new-stock" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label for="new-image">Im√°genes del Producto</label>
                    <div class="image-upload-container">
                        <input type="text" id="new-image" placeholder="URL de la imagen principal o sube archivos">
                        <div class="upload-options">
                            <button type="button" class="btn btn-secondary" id="upload-image-btn">üìÅ Subir Imagen</button>
                            <button type="button" class="btn btn-primary" id="upload-multiple-btn">üì∑ Subir M√∫ltiples</button>
                            <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                            <input type="file" id="multiple-images-input" multiple accept="image/*" style="display: none;">
                        </div>
                        <div id="image-preview" class="image-preview" style="display: none;">
                            <img id="preview-img" src="" alt="Vista previa">
                            <span class="preview-filename"></span>
                        </div>
                        <div id="multiple-images-preview" class="multiple-images-preview" style="display: none;">
                            <h4>Im√°genes seleccionadas:</h4>
                            <div id="images-list" class="images-list"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="new-status">Estado</label>
                    <select id="new-status" required>
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Crear Producto</button>
            </form>
        </div>
    </div>

    <!-- Modal para agregar/editar usuario -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="user-modal-title">Agregar Nuevo Usuario</h2>
            <form id="user-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="user-username">Username *</label>
                        <input type="text" id="user-username" required>
                    </div>
                    <div class="form-group">
                        <label for="user-password">Contrase√±a *</label>
                        <input type="password" id="user-password" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="user-nombre">Nombre</label>
                        <input type="text" id="user-nombre">
                    </div>
                    <div class="form-group">
                        <label for="user-apellido">Apellido</label>
                        <input type="text" id="user-apellido">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email">
                    </div>
                    <div class="form-group">
                        <label for="user-role">Rol *</label>
                        <select id="user-role" required>
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="user-dni">DNI</label>
                        <input type="text" id="user-dni" maxlength="8">
                    </div>
                    <div class="form-group">
                        <label for="user-telefono">Tel√©fono</label>
                        <input type="text" id="user-telefono">
                    </div>
                </div>
                <div class="form-group">
                    <label for="user-direccion">Direcci√≥n</label>
                    <textarea id="user-direccion" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="user-codigo-postal">C√≥digo Postal</label>
                        <input type="text" id="user-codigo-postal" maxlength="5">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-success">Guardar Usuario</button>
                        <button type="button" class="btn btn-secondary" id="cancel-user">Cancelar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para confirmar eliminaci√≥n de usuario -->
    <div id="delete-user-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Confirmar Eliminaci√≥n</h2>
            <p>¬øEst√°s seguro de que quieres eliminar al usuario <strong id="delete-user-name"></strong>?</p>
            <p>Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-actions">
                <button class="btn btn-danger" id="confirm-delete-user">S√≠, Eliminar</button>
                <button class="btn btn-secondary" id="cancel-delete-user">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para estad√≠sticas de im√°genes -->
    <div id="image-stats-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üìä Estad√≠sticas de Productos</h2>
            <div id="image-stats-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total de Productos</h3>
                        <p id="total-products">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Productos Activos</h3>
                        <p id="active-products">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Stock Total</h3>
                        <p id="total-stock">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Valor Total</h3>
                        <p id="total-value">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Galer√≠a de Im√°genes -->
    <div id="gallery-modal" class="gallery-modal">
        <div class="gallery-content">
            <div class="gallery-header">
                <h2 id="gallery-title">Galer√≠a de Im√°genes</h2>
                <button class="gallery-close">&times;</button>
            </div>
            
            <div class="gallery-main-image">
                <img id="gallery-main-img" src="" alt="Imagen principal">
            </div>
            
            <div class="gallery-thumbnails" id="gallery-thumbnails">
                <!-- Las miniaturas se cargar√°n din√°micamente -->
            </div>
            
            <div class="gallery-info" id="gallery-info" style="display: none;">
                <p><strong>Tip:</strong> Haz clic en las miniaturas para seleccionarlas. Usa los botones ‚Üë y ‚Üì para reordenar las im√°genes. La primera imagen ser√° la imagen principal del producto.</p>
            </div>
            
            <div class="gallery-actions">
                <button class="btn btn-primary" id="set-main-image">Establecer como Principal</button>
                <button class="btn btn-danger" id="delete-image">Eliminar Imagen</button>
                <button class="btn btn-success" id="add-images">Agregar Im√°genes</button>
            </div>
            
            <div class="gallery-upload" id="gallery-upload">
                <input type="file" id="gallery-file-input" multiple accept="image/*">
                <label for="gallery-file-input">
                    üìÅ Arrastra im√°genes aqu√≠ o haz clic para seleccionar m√∫ltiples
                </label>
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <span id="progress-text">Subiendo...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="js/admin.js"></script>
</body>
</html>